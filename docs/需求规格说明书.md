# PDF处理软件开发文档

> **版本**: v1.0.0  
> **创建日期**: 2025年2月13日  
> **文档状态**: 初稿  
> **项目代号**: PDFMaster

---

## 目录

1. [项目概述](#1-项目概述)
2. [市场分析与竞品研究](#2-市场分析与竞品研究)
3. [系统架构设计](#3-系统架构设计)
4. [功能模块详细规格](#4-功能模块详细规格)
5. [技术选型与实现方案](#5-技术选型与实现方案)
6. [API接口设计](#6-api接口设计)
7. [数据存储设计](#7-数据存储设计)
8. [安全设计](#8-安全设计)
9. [性能优化方案](#9-性能优化方案)
10. [开发规范](#10-开发规范)
11. [测试方案](#11-测试方案)
12. [部署方案](#12-部署方案)
13. [开发路线图](#13-开发路线图)
14. [附录](#14-附录)

---

## 1. 项目概述

### 1.1 项目背景

PDF（Portable Document Format）作为全球最广泛使用的文档格式之一，具有跨平台一致性、格式稳定性等特点。随着数字化转型的深入，PDF处理需求日益增长，市场对功能全面、性能优异、安全可靠的PDF处理工具需求迫切。

根据市场调研数据：
- 2024年中国信创PDF编辑器市场规模突破35亿元
- 预计2025年将达到48亿元，年增长率超37%
- 全球PDF阅读器软件市场持续增长

### 1.2 项目目标

开发一款功能完善、性能优异、安全可靠的PDF处理软件，具备以下核心能力：

| 目标维度 | 具体目标 |
|---------|---------|
| **功能完整性** | 覆盖PDF创建、编辑、转换、提取、安全等100+功能 |
| **性能优异** | 大文件处理、批量操作、并行处理能力 |
| **安全可靠** | 加密解密、数字签名、敏感信息保护 |
| **易用性** | 多平台支持、友好界面、丰富API |
| **可扩展** | 插件系统、自定义工作流、AI能力集成 |

### 1.3 目标用户

| 用户群体 | 核心需求 | 使用场景 |
|---------|---------|---------|
| **个人用户** | 简单编辑、格式转换、阅读批注 | 日常办公、学习资料处理 |
| **企业用户** | 批量处理、文档管理、安全控制 | 合同管理、报告生成、档案归档 |
| **开发者** | API调用、自动化集成 | 系统集成、自动化工作流 |
| **专业用户** | OCR识别、数字签名、PDF/A归档 | 法律文档、财务报表、学术论文 |

### 1.4 产品形态

```
┌─────────────────────────────────────────────────────────────┐
│                      PDFMaster 产品矩阵                      │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  桌面应用    │  │  Web应用    │  │  CLI工具    │         │
│  │  (跨平台)   │  │  (在线版)   │  │  (命令行)   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  REST API   │  │  SDK库     │  │  Docker镜像  │         │
│  │  (服务接口) │  │  (开发包)   │  │  (容器部署) │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 市场分析与竞品研究

### 2.1 主流PDF软件功能对比矩阵

#### 2.1.1 功能覆盖对比

| 功能类别 | 功能项 | Adobe Acrobat | Foxit PhantomPDF | PDFelement | Stirling-PDF | 本项目目标 |
|---------|-------|--------------|-----------------|------------|--------------|-----------|
| **基础操作** | PDF创建 | ✅ | ✅ | ✅ | ✅ | ✅ |
| | PDF合并 | ✅ | ✅ | ✅ | ✅ | ✅ |
| | PDF拆分 | ✅ | ✅ | ✅ | ✅ | ✅ |
| | 页面管理 | ✅ | ✅ | ✅ | ✅ | ✅ |
| | PDF压缩 | ✅ | ✅ | ✅ | ✅ | ✅ |
| **内容提取** | 文本提取 | ✅ | ✅ | ✅ | ✅ | ✅ |
| | 图片提取 | ✅ | ✅ | ✅ | ✅ | ✅ |
| | 表格提取 | ✅ | ✅ | ✅ | ✅ | ✅ |
| | 注释提取 | ✅ | ✅ | ✅ | ⚠️ | ✅ |
| **格式转换** | PDF→Word | ✅ | ✅ | ✅ | ✅ | ✅ |
| | PDF→Excel | ✅ | ✅ | ✅ | ✅ | ✅ |
| | PDF→图片 | ✅ | ✅ | ✅ | ✅ | ✅ |
| | PDF→HTML | ✅ | ✅ | ⚠️ | ✅ | ✅ |
| **编辑功能** | 文本编辑 | ✅ | ✅ | ✅ | ⚠️ | ✅ |
| | 图片编辑 | ✅ | ✅ | ✅ | ⚠️ | ✅ |
| | 水印 | ✅ | ✅ | ✅ | ✅ | ✅ |
| | 页眉页脚 | ✅ | ✅ | ✅ | ✅ | ✅ |
| **注释批注** | 高亮标注 | ✅ | ✅ | ✅ | ⚠️ | ✅ |
| | 文本批注 | ✅ | ✅ | ✅ | ⚠️ | ✅ |
| | 图章 | ✅ | ✅ | ✅ | ⚠️ | ✅ |
| | 绘图工具 | ✅ | ✅ | ✅ | ⚠️ | ✅ |
| **安全功能** | 密码加密 | ✅ | ✅ | ✅ | ✅ | ✅ |
| | 权限控制 | ✅ | ✅ | ✅ | ✅ | ✅ |
| | 数字签名 | ✅ | ✅ | ✅ | ✅ | ✅ |
| | 敏感信息遮蔽 | ✅ | ✅ | ✅ | ✅ | ✅ |
| | 电子签章 | ✅ | ✅ | ✅ | ❌ | ✅ |
| **高级功能** | OCR识别 | ✅ | ✅ | ✅ | ✅ | ✅ |
| | PDF/A转换 | ✅ | ✅ | ✅ | ✅ | ✅ |
| | 文档对比 | ✅ | ✅ | ⚠️ | ✅ | ✅ |
| | 表单填充 | ✅ | ✅ | ✅ | ⚠️ | ✅ |
| **AI功能** | 智能摘要 | ✅ | ✅ | ⚠️ | ❌ | ✅ |
| | 智能翻译 | ✅ | ⚠️ | ⚠️ | ❌ | ✅ |
| | 智能问答 | ✅ | ⚠️ | ⚠️ | ❌ | ✅ |

> ✅ 完全支持 | ⚠️ 部分支持 | ❌ 不支持

#### 2.1.2 技术架构对比

| 软件名称 | 开发语言 | 架构模式 | 部署方式 | 开源程度 |
|---------|---------|---------|---------|---------|
| Adobe Acrobat | C++ | 桌面应用 | 本地安装 | 闭源 |
| Foxit PhantomPDF | C++ | 桌面应用 | 本地安装 | 闭源 |
| PDFelement | C++/Qt | 桌面应用 | 本地安装 | 闭源 |
| Stirling-PDF | Java/Spring Boot | Web应用 | Docker | MIT开源 |
| PDF4QT | C++/Qt | 桌面应用 | 本地安装 | GPL开源 |
| **PDFMaster** | Python | 微服务架构 | 多种部署 | 核心开源 |

#### 2.1.3 定价策略对比

| 软件名称 | 商业模式 | 个人版价格 | 企业版价格 | 免费版 |
|---------|---------|-----------|-----------|--------|
| Adobe Acrobat | 订阅制 | $15/月 | $23/月 | 阅读器免费 |
| Foxit PhantomPDF | 订阅+买断 | $8/月 | $15/月 | 阅读器免费 |
| PDFelement | 订阅+买断 | $6/月 | $10/月 | 功能受限 |
| Nitro Pro | 订阅制 | $10/月 | $20/月 | 试用期 |
| Stirling-PDF | 开源免费 | 免费 | 免费 | 完全免费 |
| **PDFMaster** | 混合模式 | 免费/订阅 | 订阅制 | 基础功能免费 |

### 2.2 用户痛点分析

#### 2.2.1 痛点收集与分类

| 痛点类别 | 具体痛点 | 出现频率 | 严重程度 | 解决方案 |
|---------|---------|---------|---------|---------|
| **功能缺失** | 表格提取不准确 | 高 | 高 | Camelot + AI辅助识别 |
| | 扫描件无法处理 | 高 | 高 | OCR集成 |
| | 复杂格式转换失真 | 中 | 高 | pdf2docx + 布局重建 |
| **性能问题** | 大文件处理慢 | 高 | 中 | 流式处理 + 分块加载 |
| | 批量处理效率低 | 中 | 中 | 并行处理 + 任务队列 |
| | 内存占用过高 | 中 | 中 | 内存优化 + 缓存策略 |
| **使用体验** | 界面复杂难上手 | 中 | 低 | 简洁UI + 引导教程 |
| | 操作步骤繁琐 | 中 | 低 | 一键操作 + 快捷键 |
| | 缺少批量操作 | 高 | 中 | 批量API + 工作流 |
| **安全顾虑** | 敏感信息泄露 | 高 | 高 | 元数据清理 + 密文处理 |
| | 云端上传风险 | 中 | 高 | 本地处理选项 |
| | 加密文档难处理 | 中 | 中 | 合规解密功能 |
| **成本问题** | 商业软件昂贵 | 高 | 中 | 免费基础版 + 合理定价 |
| | 订阅费用持续 | 中 | 低 | 买断选项 |
| **兼容问题** | 中文字体乱码 | 高 | 高 | 字体映射 + 编码处理 |
| | 跨平台显示差异 | 中 | 中 | 标准化处理 |
| | 版本兼容性 | 低 | 低 | 多版本支持 |

#### 2.2.2 用户需求优先级排序

```
优先级矩阵：

                    高价值
                      │
    ┌─────────────────┼─────────────────┐
    │                 │                 │
    │   P1: 必须实现   │   P2: 应该实现   │
    │   • 文本提取    │   • OCR识别     │
    │   • PDF合并拆分 │   • 数字签名    │
    │   • 格式转换    │   • 批量处理    │
    │   • 加密解密    │   • 表格提取    │
    │                 │                 │
    │─────────────────┼─────────────────│ 高频
    │                 │                 │
    │   P3: 可以实现   │   P4: 未来实现   │
    │   • 智能摘要    │   • AI问答      │
    │   • PDF/A转换   │   • 智能翻译    │
    │   • 文档对比    │   • 自动化工作流 │
    │                 │                 │
    └─────────────────┼─────────────────┘
                      │
                    低价值
```

### 2.3 市场机会分析

| 机会点 | 描述 | 竞争优势 |
|-------|------|---------|
| **国产化替代** | 信创政策推动国产软件需求 | 完全自主可控、符合国产化标准 |
| **AI赋能** | 传统PDF软件AI能力不足 | 集成最新AI技术、智能处理 |
| **开发者友好** | 现有API文档不完善、集成困难 | 完善API、丰富SDK、详细文档 |
| **隐私保护** | 云端处理存在隐私风险 | 本地处理选项、数据不出域 |
| **性价比** | 商业软件价格高昂 | 免费基础版、合理定价策略 |

---

## 3. 系统架构设计

### 3.1 整体架构

采用**微服务架构**设计，支持灵活部署和水平扩展：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              客户端层 (Client Layer)                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │  Web Client │  │ Desktop App │  │  CLI Tool   │  │  SDK/CLI    │       │
│  │  (Vue3/React)│  │ (PyQt6/Electron)│  │  (Click)   │  │ (Python/JS) │       │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘       │
└─────────┼────────────────┼────────────────┼────────────────┼───────────────┘
          │                │                │                │
          └────────────────┴────────────────┴────────────────┘
                                    │
                          ┌─────────▼─────────┐
                          │   API Gateway     │
                          │   (Kong/Nginx)    │
                          │  • 路由转发       │
                          │  • 负载均衡       │
                          │  • 限流熔断       │
                          │  • 认证授权       │
                          └─────────┬─────────┘
                                    │
┌───────────────────────────────────┼───────────────────────────────────────┐
│                         服务层 (Service Layer)                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ 基础操作服务 │  │ 内容提取服务 │  │ 格式转换服务 │  │ 安全处理服务 │     │
│  │ core-service│  │extract-service│ │convert-service│ │security-service│ │
│  │             │  │             │  │             │  │             │     │
│  │ • PDF创建   │  │ • 文本提取   │  │ • PDF→Word  │  │ • 加密解密   │     │
│  │ • 合并拆分  │  │ • 图片提取   │  │ • PDF→Excel │  │ • 数字签名   │     │
│  │ • 页面管理  │  │ • 表格提取   │  │ • PDF→图片  │  │ • 权限控制   │     │
│  │ • 压缩优化  │  │ • 注释提取   │  │ • 格式互转  │  │ • 敏感信息   │     │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘     │
│         │                │                │                │            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ 编辑处理服务 │  │ OCR识别服务  │  │ AI智能服务  │  │ 任务调度服务 │     │
│  │ edit-service│  │ ocr-service │  │ ai-service  │  │ task-service│     │
│  │             │  │             │  │             │  │             │     │
│  │ • 文本编辑  │  │ • 文字识别   │  │ • 智能摘要  │  │ • 任务队列   │     │
│  │ • 图片编辑  │  │ • 版面分析   │  │ • 智能翻译  │  │ • 进度跟踪   │     │
│  │ • 水印处理  │  │ • 多语言支持 │  │ • 智能问答  │  │ • 批量处理   │     │
│  │ • 注释管理  │  │ • 批量OCR   │  │ • 智能书签  │  │ • 定时任务   │     │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘     │
└─────────┼────────────────┼────────────────┼────────────────┼─────────────┘
          │                │                │                │
          └────────────────┴────────────────┴────────────────┘
                                    │
┌───────────────────────────────────┼───────────────────────────────────────┐
│                         核心引擎层 (Engine Layer)                          │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                        PDF处理引擎 (PDF Engine)                       │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │ │
│  │  │ PyMuPDF  │ │ pikepdf  │ │pdfminer  │ │reportlab │ │ pdf2docx │  │ │
│  │  │ (核心)   │ │ (加密)   │ │ (提取)   │ │ (生成)   │ │ (转换)   │  │ │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘  │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │ │
│  │  │pdfplumber│ │ Camelot  │ │ Tabula   │ │ pyHanko  │ │ WeasyPrint│ │ │
│  │  │ (表格)   │ │ (表格)   │ │ (表格)   │ │ (签名)   │ │ (HTML转PDF)│ │ │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                        AI/OCR引擎 (AI/OCR Engine)                     │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │ │
│  │  │Tesseract │ │PaddleOCR │ │EasyOCR   │ │ OpenAI   │ │ 本地LLM  │  │ │
│  │  │ (OCR)    │ │ (OCR)    │ │ (OCR)    │ │ (AI API) │ │ (AI)     │  │ │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────────────────┘
                                    │
┌───────────────────────────────────┼───────────────────────────────────────┐
│                         数据存储层 (Data Layer)                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │  PostgreSQL │  │    Redis    │  │  MinIO/S3   │  │ Elasticsearch│     │
│  │  (业务数据) │  │  (缓存/队列)│  │ (文件存储)  │  │  (全文搜索) │     │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │
└───────────────────────────────────────────────────────────────────────────┘
```

### 3.2 服务拆分设计

#### 3.2.1 服务清单

| 服务名称 | 端口 | 职责描述 | 核心依赖 |
|---------|------|---------|---------|
| `api-gateway` | 8000 | API网关、路由、认证 | Kong/Nginx |
| `core-service` | 8001 | PDF基础操作 | PyMuPDF, pikepdf |
| `extract-service` | 8002 | 内容提取 | PyMuPDF, pdfminer, pdfplumber |
| `convert-service` | 8003 | 格式转换 | pdf2docx, Camelot, pdf2image |
| `edit-service` | 8004 | PDF编辑 | PyMuPDF, reportlab |
| `security-service` | 8005 | 安全处理 | pikepdf, pyHanko |
| `ocr-service` | 8006 | OCR识别 | Tesseract, PaddleOCR |
| `ai-service` | 8007 | AI智能功能 | OpenAI API, LangChain |
| `task-service` | 8008 | 任务调度 | Celery, Redis |
| `storage-service` | 8009 | 文件存储 | MinIO, S3 |

#### 3.2.2 服务通信方式

```
┌─────────────────────────────────────────────────────────────────┐
│                      服务通信架构                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   同步通信 (REST/gRPC)                                          │
│   ┌─────────┐  HTTP/REST   ┌─────────┐                         │
│   │ Client  │ ───────────► │ Gateway │                         │
│   └─────────┘              └────┬────┘                         │
│                                 │                              │
│                    ┌────────────┼────────────┐                 │
│                    ▼            ▼            ▼                 │
│              ┌─────────┐ ┌─────────┐ ┌─────────┐               │
│              │ Service │ │ Service │ │ Service │               │
│              │    A    │ │    B    │ │    C    │               │
│              └─────────┘ └─────────┘ └─────────┘               │
│                                                                 │
│   异步通信 (Message Queue)                                      │
│   ┌─────────┐              ┌─────────┐                         │
│   │ Producer│ ──► Queue ──►│Consumer │                         │
│   │ Service │              │ Service │                         │
│   └─────────┘              └─────────┘                         │
│                                                                 │
│   事件驱动 (Event Bus)                                          │
│   ┌─────────┐  Event   ┌─────────┐  Event   ┌─────────┐        │
│   │ Service │ ───────► │  Event  │ ───────► │ Service │        │
│   │    A    │          │   Bus   │          │    B    │        │
│   └─────────┘          └─────────┘          └─────────┘        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 技术栈选型

#### 3.3.1 后端技术栈

| 层级 | 技术选型 | 版本要求 | 选型理由 |
|------|---------|---------|---------|
| **开发语言** | Python | 3.10+ | PDF生态丰富、开发效率高 |
| **Web框架** | FastAPI | 0.100+ | 高性能、异步支持、自动文档 |
| **任务队列** | Celery | 5.3+ | 成熟稳定、功能完善 |
| **消息队列** | Redis / RabbitMQ | 7.0+ / 3.12+ | 高性能、可靠性 |
| **数据库** | PostgreSQL | 15+ | 功能强大、扩展性好 |
| **缓存** | Redis | 7.0+ | 高性能、多数据结构 |
| **文件存储** | MinIO | 最新 | S3兼容、高性能 |
| **搜索引擎** | Elasticsearch | 8.0+ | 全文搜索、日志分析 |
| **容器化** | Docker | 24+ | 标准化部署 |
| **编排** | Docker Compose / K8s | 最新 | 服务编排 |

#### 3.3.2 前端技术栈

| 层级 | 技术选型 | 版本要求 | 选型理由 |
|------|---------|---------|---------|
| **框架** | Vue 3 / React 18 | 最新 | 主流框架、生态完善 |
| **UI组件** | Element Plus / Ant Design | 最新 | 企业级组件库 |
| **状态管理** | Pinia / Redux Toolkit | 最新 | 现代化状态管理 |
| **构建工具** | Vite | 5.0+ | 快速构建 |
| **PDF预览** | PDF.js | 3.0+ | Mozilla开源、功能完善 |

#### 3.3.3 桌面应用技术栈

| 层级 | 技术选型 | 版本要求 | 选型理由 |
|------|---------|---------|---------|
| **框架** | PyQt6 / PySide6 | 6.0+ | 原生性能、跨平台 |
| **备选** | Electron | 最新 | Web技术栈、开发效率高 |
| **打包** | PyInstaller / cx_Freeze | 最新 | 打包分发 |

### 3.4 部署架构

#### 3.4.1 单机部署架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        单机部署架构                              │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    Docker Compose                        │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │   │
│  │  │ Nginx   │ │ API     │ │ Celery  │ │ Redis   │       │   │
│  │  │ :80     │ │ :8000   │ │ Worker  │ │ :6379   │       │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐                   │   │
│  │  │PostgreSQL│ │ MinIO   │ │ OCR     │                   │   │
│  │  │ :5432   │ │ :9000   │ │ Service │                   │   │
│  │  └─────────┘ └─────────┘ └─────────┘                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                         本地文件系统                            │
└─────────────────────────────────────────────────────────────────┘
```

#### 3.4.2 集群部署架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           集群部署架构                                   │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      负载均衡层                                  │   │
│  │                    (Nginx/HAProxy)                              │   │
│  └──────────────────────────────┬──────────────────────────────────┘   │
│                                 │                                       │
│  ┌──────────────────────────────┼──────────────────────────────────┐   │
│  │                      Kubernetes Cluster                         │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │                    Ingress Controller                    │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐  │   │
│  │  │ API Pod │ │ API Pod │ │ API Pod │ │ Worker  │ │ Worker  │  │   │
│  │  │   x3    │ │   x3    │ │   x3    │ │   Pod   │ │   Pod   │  │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘  │   │
│  └───────────────────────────────────────────────────────────────┘   │
│                                 │                                       │
│  ┌──────────────────────────────┼──────────────────────────────────┐   │
│  │                      数据层                                      │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐               │   │
│  │  │PostgreSQL│ │ Redis   │ │ MinIO   │ │Elasticsearch│            │   │
│  │  │ Cluster │ │ Cluster │ │ Cluster │ │ Cluster │               │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘               │   │
│  └───────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 功能模块详细规格

### 4.1 模块A：PDF基础操作服务 (core-service)

#### 4.1.1 PDF创建

**功能描述**：支持多种方式创建PDF文档

| 创建方式 | 输入格式 | 输出 | 配置选项 |
|---------|---------|------|---------|
| 空白创建 | 无 | PDF | 页面尺寸、方向、页数 |
| 从图片创建 | JPG/PNG/TIFF/BMP | PDF | 图片顺序、页面大小、质量 |
| 从文本创建 | TXT/MD | PDF | 字体、字号、边距、编码 |
| 从HTML创建 | HTML | PDF | CSS支持、JavaScript渲染 |
| 从模板创建 | 模板文件+数据 | PDF | 变量替换、循环、条件 |
| 从Word创建 | DOCX | PDF | 格式保真度、字体嵌入 |

**API设计**：

```python
POST /api/v1/pdf/create

Request Body:
{
    "method": "blank|image|text|html|template|word",
    "options": {
        "page_size": "A4",           # A4, A3, Letter, Legal, Custom
        "orientation": "portrait",    # portrait, landscape
        "margin": {
            "top": 25,
            "bottom": 25,
            "left": 20,
            "right": 20
        },
        "metadata": {
            "title": "文档标题",
            "author": "作者",
            "subject": "主题",
            "keywords": ["关键词1", "关键词2"]
        }
    },
    "content": {
        # 根据method不同而不同
    }
}

Response:
{
    "success": true,
    "data": {
        "file_id": "uuid",
        "download_url": "/api/v1/files/{file_id}/download",
        "page_count": 1,
        "file_size": 12345
    }
}
```

**实现方案**：

```python
from reportlab.lib.pagesizes import A4, letter
from reportlab.lib.units import mm
from reportlab.pdfgen import canvas
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer
from reportlab.lib.styles import getSampleStyleSheet
import fitz

class PDFCreator:
    def create_blank(self, page_size: str = "A4", orientation: str = "portrait") -> bytes:
        sizes = {"A4": A4, "Letter": letter}
        width, height = sizes.get(page_size, A4)
        if orientation == "landscape":
            width, height = height, width
        
        doc = fitz.open()
        page = doc.new_page(width=width, height=height)
        return doc.tobytes()
    
    def create_from_images(self, images: list, options: dict) -> bytes:
        doc = fitz.open()
        for img_path in images:
            page = doc.new_page()
            rect = page.rect
            page.insert_image(rect, filename=img_path)
        return doc.tobytes()
    
    def create_from_text(self, text: str, options: dict) -> bytes:
        buffer = io.BytesIO()
        doc = SimpleDocTemplate(buffer, pagesize=A4)
        styles = getSampleStyleSheet()
        story = []
        for line in text.split('\n'):
            story.append(Paragraph(line, styles['Normal']))
            story.append(Spacer(1, 12))
        doc.build(story)
        return buffer.getvalue()
```

#### 4.1.2 PDF合并

**功能描述**：将多个PDF文件合并为一个

| 功能点 | 描述 | 配置选项 |
|-------|------|---------|
| 多文件合并 | 按顺序合并多个PDF | 文件顺序、页码范围 |
| 选择性合并 | 只合并指定页面 | 页码范围、排除页 |
| 书签处理 | 合并/重建书签 | 保留原书签、新建书签 |
| 页码重排 | 合并后重新编排页码 | 起始页码、格式 |

**API设计**：

```python
POST /api/v1/pdf/merge

Request Body:
{
    "files": [
        {
            "file_id": "uuid1",
            "pages": "1-5,7,10-15",  # 可选，不指定则全部
            "bookmark": "第一章"       # 可选，添加书签
        },
        {
            "file_id": "uuid2",
            "pages": "all"
        }
    ],
    "options": {
        "preserve_bookmarks": true,
        "add_toc": true,
        "page_numbering": {
            "enabled": true,
            "start": 1,
            "format": "decimal"  # decimal, roman, alpha
        }
    }
}
```

**实现方案**：

```python
import fitz
from typing import List, Dict, Optional

class PDFMerger:
    def merge(self, files: List[Dict], options: Dict) -> bytes:
        result = fitz.open()
        
        for file_info in files:
            file_id = file_info['file_id']
            pages = file_info.get('pages', 'all')
            bookmark = file_info.get('bookmark')
            
            src_doc = self._get_document(file_id)
            page_indices = self._parse_page_range(pages, len(src_doc))
            
            if bookmark:
                result.set_toc_item(
                    result.page_count,
                    bookmark,
                    result.page_count
                )
            
            for idx in page_indices:
                result.insert_pdf(src_doc, from_page=idx, to_page=idx)
        
        if options.get('add_toc'):
            self._generate_toc(result)
        
        return result.tobytes()
    
    def _parse_page_range(self, range_str: str, total: int) -> List[int]:
        if range_str == 'all':
            return list(range(total))
        
        indices = []
        for part in range_str.split(','):
            if '-' in part:
                start, end = map(int, part.split('-'))
                indices.extend(range(start - 1, end))
            else:
                indices.append(int(part) - 1)
        return indices
```

#### 4.1.3 PDF拆分

**功能描述**：将PDF拆分为多个文件

| 拆分方式 | 描述 | 配置选项 |
|---------|------|---------|
| 按页拆分 | 每页一个文件 | 无 |
| 按范围拆分 | 指定页码范围 | 页码范围列表 |
| 按书签拆分 | 按书签章节拆分 | 书签层级 |
| 按大小拆分 | 按文件大小拆分 | 最大文件大小 |
| 按页数拆分 | 按固定页数拆分 | 每份页数 |

**API设计**：

```python
POST /api/v1/pdf/split

Request Body:
{
    "file_id": "uuid",
    "method": "page|range|bookmark|size|count",
    "options": {
        # 按范围拆分
        "ranges": [
            {"pages": "1-10", "name": "part1.pdf"},
            {"pages": "11-20", "name": "part2.pdf"}
        ],
        # 按书签拆分
        "bookmark_level": 1,
        # 按大小拆分
        "max_size_mb": 5,
        # 按页数拆分
        "pages_per_file": 10
    }
}

Response:
{
    "success": true,
    "data": {
        "files": [
            {"file_id": "uuid1", "name": "part1.pdf", "pages": 10},
            {"file_id": "uuid2", "name": "part2.pdf", "pages": 10}
        ]
    }
}
```

#### 4.1.4 页面管理

**功能描述**：管理PDF页面

| 操作 | 描述 | API端点 |
|-----|------|--------|
| 旋转 | 旋转指定页面 | POST /api/v1/pdf/pages/rotate |
| 删除 | 删除指定页面 | DELETE /api/v1/pdf/pages |
| 提取 | 提取指定页面 | POST /api/v1/pdf/pages/extract |
| 插入 | 在指定位置插入页面 | POST /api/v1/pdf/pages/insert |
| 移动 | 移动页面位置 | POST /api/v1/pdf/pages/move |
| 裁剪 | 裁剪页面 | POST /api/v1/pdf/pages/crop |
| 复制 | 复制页面 | POST /api/v1/pdf/pages/copy |

**API设计示例**：

```python
POST /api/v1/pdf/pages/rotate

Request Body:
{
    "file_id": "uuid",
    "pages": "1-5,10",      # 页码范围
    "angle": 90,            # 90, 180, 270
    "direction": "clockwise"  # clockwise, counterclockwise
}

POST /api/v1/pdf/pages/crop

Request Body:
{
    "file_id": "uuid",
    "pages": "all",
    "crop_box": {
        "left": 10,      # 单位：mm
        "right": 10,
        "top": 10,
        "bottom": 10
    }
}
```

#### 4.1.5 PDF压缩

**功能描述**：减小PDF文件体积

| 压缩选项 | 描述 | 效果 |
|---------|------|------|
| 图像压缩 | 降低图像分辨率和质量 | 显著减小 |
| 字体子集化 | 只嵌入使用的字符 | 中等减小 |
| 对象压缩 | 压缩PDF内部对象 | 中等减小 |
| 元数据清理 | 移除不必要的元数据 | 轻微减小 |
| 结构优化 | 优化PDF结构 | 轻微减小 |

**压缩级别预设**：

```python
COMPRESSION_PRESETS = {
    "low": {
        "image_quality": 90,
        "image_dpi": 150,
        "subset_fonts": False,
        "compress_objects": False
    },
    "medium": {
        "image_quality": 75,
        "image_dpi": 120,
        "subset_fonts": True,
        "compress_objects": True
    },
    "high": {
        "image_quality": 50,
        "image_dpi": 72,
        "subset_fonts": True,
        "compress_objects": True,
        "remove_metadata": True,
        "remove_unused_objects": True
    }
}
```

**API设计**：

```python
POST /api/v1/pdf/compress

Request Body:
{
    "file_id": "uuid",
    "preset": "low|medium|high",
    "custom_options": {
        "image_quality": 75,
        "image_dpi": 120,
        "subset_fonts": true,
        "remove_metadata": false
    }
}

Response:
{
    "success": true,
    "data": {
        "original_size": 10485760,
        "compressed_size": 5242880,
        "compression_ratio": 0.5,
        "file_id": "uuid_compressed"
    }
}
```

### 4.2 模块B：内容提取服务 (extract-service)

#### 4.2.1 文本提取

**功能描述**：从PDF中提取文本内容

| 提取模式 | 描述 | 适用场景 |
|---------|------|---------|
| 纯文本 | 仅提取文本内容 | 全文搜索、内容分析 |
| 带位置 | 提取文本及坐标位置 | 布局分析、内容定位 |
| 带格式 | 保留字体、大小、颜色 | 格式还原 |
| 结构化 | 按段落、标题结构化 | 文档解析 |

**API设计**：

```python
POST /api/v1/extract/text

Request Body:
{
    "file_id": "uuid",
    "pages": "all",           # 页码范围
    "mode": "plain|position|formatted|structured",
    "options": {
        "preserve_layout": true,
        "include_images_alt": false,
        "encoding": "utf-8"
    }
}

Response:
{
    "success": true,
    "data": {
        "text": "提取的文本内容...",
        "pages": [
            {
                "page_num": 1,
                "text": "第一页内容",
                "blocks": [
                    {
                        "type": "text",
                        "bbox": [x0, y0, x1, y1],
                        "text": "段落文本",
                        "font": "SimSun",
                        "size": 12
                    }
                ]
            }
        ]
    }
}
```

**实现方案**：

```python
import fitz
from pdfminer.high_level import extract_text, extract_pages
from pdfminer.layout import LTTextContainer, LTChar

class TextExtractor:
    def extract_plain(self, pdf_path: str) -> str:
        return extract_text(pdf_path)
    
    def extract_with_position(self, pdf_path: str) -> dict:
        doc = fitz.open(pdf_path)
        result = {"pages": []}
        
        for page_num, page in enumerate(doc):
            page_data = {
                "page_num": page_num + 1,
                "blocks": []
            }
            
            blocks = page.get_text("dict")["blocks"]
            for block in blocks:
                if block["type"] == 0:  # 文本块
                    for line in block["lines"]:
                        for span in line["spans"]:
                            page_data["blocks"].append({
                                "type": "text",
                                "bbox": span["bbox"],
                                "text": span["text"],
                                "font": span["font"],
                                "size": span["size"]
                            })
            
            result["pages"].append(page_data)
        
        return result
    
    def extract_structured(self, pdf_path: str) -> dict:
        result = {"sections": []}
        
        for page_layout in extract_pages(pdf_path):
            for element in page_layout:
                if isinstance(element, LTTextContainer):
                    text = element.get_text()
                    if self._is_heading(text):
                        result["sections"].append({
                            "type": "heading",
                            "level": self._detect_heading_level(text),
                            "text": text.strip()
                        })
                    else:
                        result["sections"].append({
                            "type": "paragraph",
                            "text": text.strip()
                        })
        
        return result
```

#### 4.2.2 图片提取

**功能描述**：从PDF中提取嵌入的图片

| 提取选项 | 描述 |
|---------|------|
| 格式转换 | 支持输出为PNG/JPG/TIFF等格式 |
| 质量控制 | 可设置输出图片质量 |
| 去重 | 自动去除重复图片 |
| 元数据 | 提取图片EXIF信息 |

**API设计**：

```python
POST /api/v1/extract/images

Request Body:
{
    "file_id": "uuid",
    "pages": "all",
    "output_format": "png|jpg|tiff",
    "options": {
        "quality": 95,
        "min_size": 100,        # 最小尺寸（像素）
        "deduplicate": true,
        "include_metadata": true
    }
}

Response:
{
    "success": true,
    "data": {
        "images": [
            {
                "image_id": "img_001",
                "page": 1,
                "bbox": [x0, y0, x1, y1],
                "width": 800,
                "height": 600,
                "format": "JPEG",
                "size": 102400,
                "download_url": "/api/v1/files/img_001/download"
            }
        ],
        "total_count": 5
    }
}
```

#### 4.2.3 表格提取

**功能描述**：从PDF中识别并提取表格数据

| 提取引擎 | 特点 | 适用场景 |
|---------|------|---------|
| pdfplumber | 简单易用、准确率高 | 有边框表格 |
| Camelot | 双模式、支持无边框 | 复杂表格 |
| Tabula | Java实现、稳定 | 简单表格 |

**API设计**：

```python
POST /api/v1/extract/tables

Request Body:
{
    "file_id": "uuid",
    "pages": "all",
    "engine": "pdfplumber|camelot|tabula",
    "options": {
        "camelot_flavor": "lattice|stream",  # Camelot专用
        "line_scale": 40,                     # 线条检测灵敏度
        "output_format": "json|csv|excel"
    }
}

Response:
{
    "success": true,
    "data": {
        "tables": [
            {
                "page": 1,
                "bbox": [x0, y0, x1, y1],
                "rows": [
                    ["列1", "列2", "列3"],
                    ["数据1", "数据2", "数据3"]
                ],
                "accuracy": 0.95
            }
        ],
        "download_url": "/api/v1/files/{file_id}/tables.xlsx"
    }
}
```

**实现方案**：

```python
import pdfplumber
import camelot
from tabula import read_pdf

class TableExtractor:
    def extract_with_pdfplumber(self, pdf_path: str) -> list:
        tables = []
        with pdfplumber.open(pdf_path) as pdf:
            for page_num, page in enumerate(pdf.pages):
                page_tables = page.extract_tables()
                for table in page_tables:
                    tables.append({
                        "page": page_num + 1,
                        "rows": table
                    })
        return tables
    
    def extract_with_camelot(self, pdf_path: str, flavor: str = "lattice") -> list:
        tables = camelot.read_pdf(pdf_path, flavor=flavor)
        result = []
        for table in tables:
            result.append({
                "page": table.page,
                "bbox": table._bbox,
                "rows": table.df.values.tolist(),
                "accuracy": table.accuracy
            })
        return result
    
    def extract_with_tabula(self, pdf_path: str) -> list:
        dfs = read_pdf(pdf_path, pages="all")
        result = []
        for i, df in enumerate(dfs):
            result.append({
                "page": i + 1,
                "rows": df.values.tolist(),
                "headers": df.columns.tolist()
            })
        return result
```

#### 4.2.4 注释提取

**功能描述**：提取PDF中的各类注释

| 注释类型 | 描述 | 提取内容 |
|---------|------|---------|
| 高亮 | 文本高亮标注 | 高亮文本、颜色、页码 |
| 下划线 | 文本下划线 | 下划线文本、样式 |
| 批注 | 文本批注评论 | 批注内容、作者、日期 |
| 图章 | 印章、图章 | 图章类型、位置 |
| 附件 | 嵌入附件 | 附件文件、名称 |
| 链接 | 超链接 | 链接URL、文本 |

**API设计**：

```python
POST /api/v1/extract/annotations

Request Body:
{
    "file_id": "uuid",
    "types": ["highlight", "underline", "text", "stamp", "link"],
    "options": {
        "include_content": true
    }
}

Response:
{
    "success": true,
    "data": {
        "annotations": [
            {
                "type": "highlight",
                "page": 1,
                "bbox": [x0, y0, x1, y1],
                "color": "#FFFF00",
                "text": "高亮的文本内容",
                "author": "用户名",
                "created": "2025-01-01T00:00:00Z"
            },
            {
                "type": "text",
                "page": 2,
                "bbox": [x0, y0, x1, y1],
                "content": "批注内容",
                "author": "用户名"
            }
        ]
    }
}
```

#### 4.2.5 元数据提取

**功能描述**：提取PDF文档元数据

```python
POST /api/v1/extract/metadata

Request Body:
{
    "file_id": "uuid"
}

Response:
{
    "success": true,
    "data": {
        "metadata": {
            "title": "文档标题",
            "author": "作者",
            "subject": "主题",
            "keywords": ["关键词"],
            "creator": "创建工具",
            "producer": "生成工具",
            "creation_date": "2025-01-01T00:00:00Z",
            "modification_date": "2025-01-02T00:00:00Z",
            "pdf_version": "1.7",
            "page_count": 10,
            "file_size": 1048576,
            "encrypted": false,
            "permissions": {
                "print": true,
                "copy": true,
                "modify": true
            }
        },
        "xmp_metadata": {
            # XMP扩展元数据
        }
    }
}
```

### 4.3 模块C：格式转换服务 (convert-service)

#### 4.3.1 PDF转Word

**功能描述**：将PDF转换为可编辑的Word文档

| 转换选项 | 描述 |
|---------|------|
| 布局模式 | 流式布局 / 原始布局 |
| 图片处理 | 嵌入图片 / 链接图片 |
| 表格识别 | 自动识别表格 |
| OCR辅助 | 扫描件OCR后转换 |

**API设计**：

```python
POST /api/v1/convert/pdf-to-word

Request Body:
{
    "file_id": "uuid",
    "options": {
        "layout_mode": "flow|original",  # 流式/原始布局
        "include_images": true,
        "recognize_tables": true,
        "ocr_enabled": false,
        "ocr_language": "chi_sim+eng"
    }
}

Response:
{
    "success": true,
    "data": {
        "file_id": "uuid_docx",
        "download_url": "/api/v1/files/uuid_docx/download",
        "conversion_quality": 0.92,
        "pages_converted": 10
    }
}
```

**实现方案**：

```python
from pdf2docx import Converter

class PDFToWordConverter:
    def convert(self, pdf_path: str, output_path: str, options: dict) -> dict:
        cv = Converter(pdf_path)
        
        cv.convert(
            output_path,
            start=0,
            end=None,
            layout=options.get("layout_mode", "flow"),
            multi_processing=True
        )
        
        cv.close()
        
        return {
            "output_path": output_path,
            "conversion_quality": self._estimate_quality(pdf_path, output_path)
        }
```

#### 4.3.2 PDF转Excel

**功能描述**：将PDF表格转换为Excel

**API设计**：

```python
POST /api/v1/convert/pdf-to-excel

Request Body:
{
    "file_id": "uuid",
    "options": {
        "engine": "camelot|tabula|pdfplumber",
        "detect_tables": true,
        "merge_tables": false,
        "sheet_per_page": false
    }
}
```

#### 4.3.3 PDF转图片

**功能描述**：将PDF页面转换为图片

**API设计**：

```python
POST /api/v1/convert/pdf-to-image

Request Body:
{
    "file_id": "uuid",
    "pages": "all",
    "options": {
        "format": "png|jpg|tiff",
        "dpi": 150,
        "quality": 95,
        "color_mode": "rgb|grayscale|bw",
        "background": "white|transparent"
    }
}

Response:
{
    "success": true,
    "data": {
        "images": [
            {
                "page": 1,
                "file_id": "uuid_img_001",
                "width": 1240,
                "height": 1754,
                "download_url": "/api/v1/files/uuid_img_001/download"
            }
        ]
    }
}
```

#### 4.3.4 其他格式转换

| 转换方向 | API端点 | 技术方案 |
|---------|--------|---------|
| PDF → HTML | POST /api/v1/convert/pdf-to-html | pdfminer + BeautifulSoup |
| PDF → Markdown | POST /api/v1/convert/pdf-to-md | 自定义解析器 |
| PDF → TXT | POST /api/v1/convert/pdf-to-txt | PyMuPDF |
| PDF → PDF/A | POST /api/v1/convert/pdf-to-pdfa | Ghostscript |
| Word → PDF | POST /api/v1/convert/word-to-pdf | python-docx + reportlab |
| Excel → PDF | POST /api/v1/convert/excel-to-pdf | openpyxl + reportlab |
| HTML → PDF | POST /api/v1/convert/html-to-pdf | WeasyPrint |
| 图片 → PDF | POST /api/v1/convert/image-to-pdf | PyMuPDF |

### 4.4 模块D：编辑处理服务 (edit-service)

#### 4.4.1 文本编辑

**功能描述**：编辑PDF中的文本内容

| 操作 | 描述 |
|-----|------|
| 添加文本 | 在指定位置添加文本 |
| 修改文本 | 修改现有文本内容 |
| 删除文本 | 删除文本内容 |
| 文本样式 | 设置字体、大小、颜色 |

**API设计**：

```python
POST /api/v1/edit/text/add

Request Body:
{
    "file_id": "uuid",
    "text": "要添加的文本",
    "position": {
        "page": 1,
        "x": 100,
        "y": 100
    },
    "style": {
        "font": "SimSun",
        "size": 12,
        "color": "#000000",
        "bold": false,
        "italic": false
    }
}

POST /api/v1/edit/text/modify

Request Body:
{
    "file_id": "uuid",
    "operations": [
        {
            "type": "replace",
            "search": "原文本",
            "replace": "新文本",
            "scope": "all|page|selection"
        }
    ]
}
```

#### 4.4.2 图片编辑

**API设计**：

```python
POST /api/v1/edit/image/add

Request Body:
{
    "file_id": "uuid",
    "image_file_id": "uuid_img",
    "position": {
        "page": 1,
        "x": 100,
        "y": 100,
        "width": 200,
        "height": 150
    },
    "options": {
        "keep_aspect_ratio": true,
        "rotate": 0
    }
}

POST /api/v1/edit/image/delete

Request Body:
{
    "file_id": "uuid",
    "image_ids": ["img_001", "img_002"]
}
```

#### 4.4.3 水印处理

**功能描述**：添加文字或图片水印

| 水印类型 | 配置选项 |
|---------|---------|
| 文字水印 | 文本、字体、大小、颜色、透明度、旋转角度、位置 |
| 图片水印 | 图片、透明度、位置、缩放 |

**API设计**：

```python
POST /api/v1/edit/watermark/add

Request Body:
{
    "file_id": "uuid",
    "type": "text|image",
    "content": {
        # 文字水印
        "text": "机密文档",
        "font": "SimSun",
        "size": 48,
        "color": "#FF0000",
        
        # 或图片水印
        "image_file_id": "uuid_img"
    },
    "options": {
        "opacity": 0.3,
        "rotation": 45,
        "position": "center|diagonal|custom",
        "pages": "all",
        "tile": true,           # 平铺
        "tile_spacing": 100     # 平铺间距
    }
}
```

**实现方案**：

```python
import fitz

class WatermarkProcessor:
    def add_text_watermark(self, pdf_path: str, options: dict) -> bytes:
        doc = fitz.open(pdf_path)
        
        text = options["content"]["text"]
        font_size = options["content"].get("size", 48)
        color = options["content"].get("color", "#FF0000")
        opacity = options["options"].get("opacity", 0.3)
        rotation = options["options"].get("rotation", 45)
        
        for page in doc:
            rect = page.rect
            center_x = rect.width / 2
            center_y = rect.height / 2
            
            shape = page.new_shape()
            shape.insert_text(
                (center_x, center_y),
                text,
                fontsize=font_size,
                color=self._hex_to_rgb(color),
                rotate=rotation
            )
            shape.commit()
        
        return doc.tobytes()
```

#### 4.4.4 页眉页脚

**API设计**：

```python
POST /api/v1/edit/header-footer/add

Request Body:
{
    "file_id": "uuid",
    "header": {
        "left": "公司名称",
        "center": "",
        "right": "文档标题",
        "font": {"size": 10, "color": "#666666"}
    },
    "footer": {
        "left": "",
        "center": "第 {page} 页 / 共 {total} 页",
        "right": "{date}",
        "font": {"size": 10, "color": "#666666"}
    },
    "pages": "all",
    "margins": {"top": 20, "bottom": 20}
}
```

#### 4.4.5 注释管理

**API设计**：

```python
POST /api/v1/edit/annotation/add

Request Body:
{
    "file_id": "uuid",
    "type": "highlight|underline|text|stamp|drawing",
    "page": 1,
    "content": {
        # 高亮
        "rect": [x0, y0, x1, y1],
        "color": "#FFFF00",
        
        # 或文本批注
        "rect": [x0, y0, x1, y1],
        "text": "批注内容",
        
        # 或图章
        "stamp_type": "Approved|Confidential|Draft",
        "rect": [x0, y0, x1, y1]
    },
    "author": "用户名"
}

DELETE /api/v1/edit/annotation

Request Body:
{
    "file_id": "uuid",
    "annotation_ids": ["ann_001", "ann_002"]
}
```

### 4.5 模块E：安全处理服务 (security-service)

#### 4.5.1 密码加密

**功能描述**：为PDF添加密码保护

| 加密算法 | 密钥长度 | 安全性 |
|---------|---------|--------|
| RC4 | 40/128位 | 已不推荐 |
| AES-128 | 128位 | 安全 |
| AES-256 | 256位 | 最安全 |

**权限控制**：

| 权限 | 描述 |
|-----|------|
| 打印 | 允许打印文档 |
| 高质量打印 | 允许高质量打印 |
| 复制文本 | 允许复制文本和图片 |
| 提取内容 | 允许提取内容 |
| 修改文档 | 允许修改文档 |
| 填写表单 | 允许填写表单域 |
| 添加注释 | 允许添加注释 |

**API设计**：

```python
POST /api/v1/security/encrypt

Request Body:
{
    "file_id": "uuid",
    "user_password": "user123",      # 打开密码
    "owner_password": "owner123",    # 权限密码
    "encryption": {
        "algorithm": "AES-256",
        "key_length": 256
    },
    "permissions": {
        "print": true,
        "print_high_quality": false,
        "copy": false,
        "modify": false,
        "fill_forms": true,
        "extract": false,
        "annotate": true
    }
}
```

#### 4.5.2 密码解密

**API设计**：

```python
POST /api/v1/security/decrypt

Request Body:
{
    "file_id": "uuid",
    "password": "user123"
}

Response:
{
    "success": true,
    "data": {
        "decrypted_file_id": "uuid_decrypted",
        "permissions": {
            "print": true,
            "copy": true,
            "modify": true
        }
    }
}
```

#### 4.5.3 数字签名

**功能描述**：为PDF添加数字签名

| 签名类型 | 描述 |
|---------|------|
| 批准签名 | 表示文档已批准 |
| 认证签名 | 确保文档完整性 |
| 时间戳签名 | 添加可信时间戳 |

**API设计**：

```python
POST /api/v1/security/sign

Request Body:
{
    "file_id": "uuid",
    "certificate": {
        "pfx_file_id": "uuid_pfx",    # 证书文件
        "password": "cert123"
    },
    "signature": {
        "type": "approval|certification",
        "reason": "文档审批",
        "location": "北京市",
        "contact": "user@example.com",
        "visible": true,
        "position": {
            "page": 1,
            "rect": [100, 100, 200, 150]
        },
        "appearance": {
            "show_name": true,
            "show_date": true,
            "show_reason": true,
            "background_image": "uuid_img"
        }
    },
    "timestamp": {
        "enabled": true,
        "server_url": "http://timestamp.example.com"
    }
}

POST /api/v1/security/verify-signature

Request Body:
{
    "file_id": "uuid"
}

Response:
{
    "success": true,
    "data": {
        "signatures": [
            {
                "signer": "张三",
                "date": "2025-01-01T00:00:00Z",
                "valid": true,
                "certificate_valid": true,
                "document_integrity": true
            }
        ]
    }
}
```

#### 4.5.4 敏感信息遮蔽

**功能描述**：永久删除PDF中的敏感信息

**API设计**：

```python
POST /api/v1/security/redact

Request Body:
{
    "file_id": "uuid",
    "redactions": [
        {
            "type": "text",
            "pages": "all",
            "patterns": ["\\d{18}", "\\d{11}"],  # 身份证号、手机号
            "overlay_color": "#000000"
        },
        {
            "type": "rect",
            "page": 1,
            "rect": [x0, y0, x1, y1]
        }
    ],
    "options": {
        "remove_metadata": true,
        "remove_hidden_text": true,
        "flatten": true
    }
}
```

#### 4.5.5 电子签章（中国合规）

**功能描述**：符合《电子签名法》的电子签章

**合规要求**：
- CA机构认证
- 实名认证
- 时间戳服务
- 证据保全

**API设计**：

```python
POST /api/v1/security/e-seal

Request Body:
{
    "file_id": "uuid",
    "seal": {
        "image_file_id": "uuid_seal_img",  # 印章图片
        "ca_provider": "cfca|szca|bjca",   # CA机构
        "position": {
            "page": 1,
            "x": 100,
            "y": 100
        }
    },
    "signer": {
        "name": "张三",
        "id_number": "110***********1234",
        "phone": "138****1234"
    },
    "options": {
        "add_timestamp": true,
        "add_qrcode": true    # 添加验证二维码
    }
}
```

### 4.6 模块F：OCR识别服务 (ocr-service)

#### 4.6.1 文字识别

**功能描述**：识别图片PDF中的文字

| OCR引擎 | 特点 | 适用场景 |
|---------|------|---------|
| Tesseract | 开源免费、多语言 | 通用场景 |
| PaddleOCR | 中文优秀、版面分析 | 中文文档 |
| EasyOCR | 多语言、易用 | 多语言文档 |

**API设计**：

```python
POST /api/v1/ocr/recognize

Request Body:
{
    "file_id": "uuid",
    "pages": "all",
    "engine": "tesseract|paddleocr|easyocr",
    "options": {
        "languages": ["chi_sim", "eng"],
        "output_mode": "text|pdf|both",  # 纯文本/可搜索PDF/两者
        "preserve_layout": true,
        "deskew": true,                  # 自动纠偏
        "enhance": true                  # 图像增强
    }
}

Response:
{
    "success": true,
    "data": {
        "text": "识别出的文本...",
        "searchable_pdf_id": "uuid_ocr_pdf",
        "confidence": 0.95,
        "pages": [
            {
                "page": 1,
                "text": "第一页文本",
                "blocks": [
                    {
                        "bbox": [x0, y0, x1, y1],
                        "text": "文本块",
                        "confidence": 0.98
                    }
                ]
            }
        ]
    }
}
```

**实现方案**：

```python
import pytesseract
from paddleocr import PaddleOCR
import fitz

class OCRProcessor:
    def __init__(self):
        self.paddle_ocr = PaddleOCR(use_angle_cls=True, lang='ch')
    
    def recognize_with_tesseract(self, pdf_path: str, languages: list) -> dict:
        doc = fitz.open(pdf_path)
        result = {"pages": []}
        
        for page_num, page in enumerate(doc):
            pix = page.get_pixmap(dpi=200)
            img_path = f"/tmp/page_{page_num}.png"
            pix.save(img_path)
            
            text = pytesseract.image_to_string(
                img_path,
                lang='+'.join(languages)
            )
            
            result["pages"].append({
                "page": page_num + 1,
                "text": text
            })
        
        return result
    
    def recognize_with_paddleocr(self, pdf_path: str) -> dict:
        doc = fitz.open(pdf_path)
        result = {"pages": []}
        
        for page_num, page in enumerate(doc):
            pix = page.get_pixmap(dpi=200)
            img_path = f"/tmp/page_{page_num}.png"
            pix.save(img_path)
            
            ocr_result = self.paddle_ocr.ocr(img_path, cls=True)
            
            blocks = []
            for line in ocr_result:
                for word_info in line:
                    blocks.append({
                        "bbox": word_info[0],
                        "text": word_info[1][0],
                        "confidence": word_info[1][1]
                    })
            
            result["pages"].append({
                "page": page_num + 1,
                "blocks": blocks
            })
        
        return result
    
    def create_searchable_pdf(self, pdf_path: str, ocr_result: dict) -> bytes:
        doc = fitz.open(pdf_path)
        
        for page_data in ocr_result["pages"]:
            page = doc[page_data["page"] - 1]
            for block in page_data["blocks"]:
                rect = fitz.Rect(block["bbox"])
                page.insert_text(
                    rect.tl,
                    block["text"],
                    fontsize=1,
                    render_mode=3  # 隐藏文本
                )
        
        return doc.tobytes()
```

#### 4.6.2 版面分析

**功能描述**：分析PDF页面布局结构

**API设计**：

```python
POST /api/v1/ocr/layout-analysis

Request Body:
{
    "file_id": "uuid",
    "pages": "all"
}

Response:
{
    "success": true,
    "data": {
        "pages": [
            {
                "page": 1,
                "regions": [
                    {
                        "type": "title",
                        "bbox": [x0, y0, x1, y1],
                        "text": "文档标题"
                    },
                    {
                        "type": "paragraph",
                        "bbox": [x0, y0, x1, y1],
                        "text": "段落内容..."
                    },
                    {
                        "type": "table",
                        "bbox": [x0, y0, x1, y1],
                        "rows": 5,
                        "cols": 3
                    },
                    {
                        "type": "figure",
                        "bbox": [x0, y0, x1, y1]
                    }
                ]
            }
        ]
    }
}
```

### 4.7 模块G：AI智能服务 (ai-service)

#### 4.7.1 智能摘要

**API设计**：

```python
POST /api/v1/ai/summarize

Request Body:
{
    "file_id": "uuid",
    "options": {
        "max_length": 500,           # 最大摘要长度
        "style": "brief|detailed",   # 简要/详细
        "language": "zh|en"          # 输出语言
    }
}

Response:
{
    "success": true,
    "data": {
        "summary": "文档摘要内容...",
        "key_points": [
            "要点1",
            "要点2",
            "要点3"
        ],
        "keywords": ["关键词1", "关键词2"]
    }
}
```

#### 4.7.2 智能问答

**API设计**：

```python
POST /api/v1/ai/chat

Request Body:
{
    "file_id": "uuid",
    "question": "这份文档的主要内容是什么？",
    "options": {
        "include_sources": true,     # 包含引用来源
        "max_context": 4000          # 最大上下文长度
    }
}

Response:
{
    "success": true,
    "data": {
        "answer": "根据文档内容，主要内容包括...",
        "sources": [
            {
                "page": 1,
                "text": "引用的原文片段...",
                "bbox": [x0, y0, x1, y1]
            }
        ]
    }
}
```

#### 4.7.3 智能翻译

**API设计**：

```python
POST /api/v1/ai/translate

Request Body:
{
    "file_id": "uuid",
    "source_language": "en",
    "target_language": "zh",
    "options": {
        "preserve_layout": true,     # 保持排版
        "translate_tables": true,    # 翻译表格
        "exclude_terms": ["PDF", "API"]  # 不翻译的术语
    }
}

Response:
{
    "success": true,
    "data": {
        "translated_file_id": "uuid_translated",
        "download_url": "/api/v1/files/uuid_translated/download"
    }
}
```

#### 4.7.4 智能书签生成

**API设计**：

```python
POST /api/v1/ai/generate-bookmarks

Request Body:
{
    "file_id": "uuid",
    "options": {
        "detect_level": 3,           # 检测层级
        "min_font_ratio": 1.2        # 标题字体比例阈值
    }
}

Response:
{
    "success": true,
    "data": {
        "bookmarks": [
            {
                "title": "第一章 概述",
                "level": 1,
                "page": 1
            },
            {
                "title": "1.1 背景",
                "level": 2,
                "page": 2
            }
        ],
        "file_id": "uuid_with_bookmarks"
    }
}
```

### 4.8 模块H：任务调度服务 (task-service)

#### 4.8.1 异步任务管理

**API设计**：

```python
POST /api/v1/tasks/create

Request Body:
{
    "task_type": "merge|split|convert|ocr|batch",
    "params": {
        # 任务参数
    },
    "callback_url": "https://example.com/callback",  # 可选回调
    "priority": "normal|high|low"
}

Response:
{
    "success": true,
    "data": {
        "task_id": "task_uuid",
        "status": "pending"
    }
}

GET /api/v1/tasks/{task_id}

Response:
{
    "success": true,
    "data": {
        "task_id": "task_uuid",
        "status": "pending|processing|completed|failed",
        "progress": 75,
        "result": {
            # 任务结果
        },
        "created_at": "2025-01-01T00:00:00Z",
        "completed_at": "2025-01-01T00:01:00Z"
    }
}
```

#### 4.8.2 批量处理

**API设计**：

```python
POST /api/v1/batch/create

Request Body:
{
    "operation": "compress|convert|watermark|ocr",
    "files": ["uuid1", "uuid2", "uuid3"],
    "options": {
        # 操作选项
    },
    "output": {
        "naming": "original|prefix|suffix",
        "prefix": "processed_",
        "suffix": "_compressed"
    }
}

Response:
{
    "success": true,
    "data": {
        "batch_id": "batch_uuid",
        "total_files": 3,
        "status": "pending"
    }
}
```

---

## 5. 技术选型与实现方案

### 5.1 PDF处理库详细对比

#### 5.1.1 核心库能力矩阵

| 库名 | 创建 | 编辑 | 提取 | 合并 | 拆分 | 加密 | 签名 | OCR | 性能 | 许可 |
|-----|------|------|------|------|------|------|------|-----|------|------|
| PyMuPDF | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ⚠️ | ❌ | ⭐⭐⭐⭐⭐ | AGPL/商业 |
| pikepdf | ⚠️ | ⚠️ | ⚠️ | ✅ | ✅ | ✅ | ✅ | ❌ | ⭐⭐⭐⭐ | MPL-2.0 |
| PyPDF2 | ⚠️ | ❌ | ⚠️ | ✅ | ✅ | ✅ | ❌ | ❌ | ⭐⭐⭐ | BSD |
| pdfminer | ❌ | ❌ | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ⭐⭐ | MIT |
| reportlab | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ⭐⭐⭐⭐ | BSD |
| pdf2docx | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ⭐⭐⭐ | MIT |
| pyHanko | ❌ | ❌ | ❌ | ❌ | ❌ | ⚠️ | ✅ | ❌ | ⭐⭐⭐ | MIT |

#### 5.1.2 库选型建议

```
┌─────────────────────────────────────────────────────────────────┐
│                     PDF处理库选型决策树                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  需求：PDF基础操作（创建、编辑、提取、合并、拆分）               │
│  └── 首选：PyMuPDF (fitz)                                       │
│      └── 备选：pikepdf（开源友好）                              │
│                                                                 │
│  需求：文本提取（高精度）                                        │
│  └── 首选：pdfminer.six                                         │
│      └── 备选：PyMuPDF                                          │
│                                                                 │
│  需求：表格提取                                                 │
│  └── 有边框表格：pdfplumber                                     │
│  └── 无边框表格：Camelot (Lattice模式)                          │
│  └── 简单表格：Tabula                                           │
│                                                                 │
│  需求：PDF创建（复杂布局）                                       │
│  └── 首选：reportlab                                            │
│  └── HTML转PDF：WeasyPrint                                      │
│                                                                 │
│  需求：PDF转Word                                                │
│  └── 首选：pdf2docx                                             │
│                                                                 │
│  需求：数字签名                                                 │
│  └── 首选：pyHanko                                              │
│      └── 备选：endesive                                         │
│                                                                 │
│  需求：OCR识别                                                  │
│  └── 中文：PaddleOCR                                            │
│  └── 多语言：Tesseract / EasyOCR                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 核心依赖清单

```toml
[project.dependencies]
web-framework = [
    "fastapi>=0.100.0",
    "uvicorn[standard]>=0.23.0",
    "python-multipart>=0.0.6",
]

pdf-core = [
    "PyMuPDF>=1.23.0",           # 核心PDF处理
    "pikepdf>=8.0.0",            # 加密、签名
    "pypdf>=3.0.0",              # 基础操作备选
]

pdf-extract = [
    "pdfminer.six>=20221105",    # 文本提取
    "pdfplumber>=0.10.0",        # 表格提取
    "camelot-py[cv]>=0.11.0",    # 高级表格提取
    "tabula-py>=2.9.0",          # Java表格提取
]

pdf-create = [
    "reportlab>=4.0.0",          # PDF生成
    "weasyprint>=60.0",          # HTML转PDF
]

pdf-convert = [
    "pdf2docx>=0.5.0",           # PDF转Word
    "pdf2image>=1.16.0",         # PDF转图片
    "python-docx>=1.0.0",        # Word操作
    "openpyxl>=3.1.0",           # Excel操作
    "python-pptx>=0.6.0",        # PPT操作
]

pdf-security = [
    "pyHanko>=0.21.0",           # 数字签名
    "cryptography>=41.0.0",      # 加密基础
    "pyopenssl>=23.0.0",         # 证书处理
]

ocr = [
    "pytesseract>=0.3.10",       # Tesseract封装
    "paddleocr>=2.7.0",          # PaddleOCR
    "easyocr>=1.7.0",            # EasyOCR备选
]

ai = [
    "openai>=1.0.0",             # OpenAI API
    "langchain>=0.1.0",          # LLM框架
    "tiktoken>=0.5.0",           # Token计算
]

task-queue = [
    "celery>=5.3.0",             # 任务队列
    "redis>=5.0.0",              # 消息队列/缓存
]

database = [
    "sqlalchemy>=2.0.0",         # ORM
    "asyncpg>=0.28.0",           # PostgreSQL异步
    "alembic>=1.12.0",           # 数据库迁移
]

storage = [
    "minio>=7.1.0",              # MinIO客户端
    "boto3>=1.28.0",             # S3兼容
]

utils = [
    "pydantic>=2.0.0",           # 数据验证
    "python-jose[cryptography]>=3.3.0",  # JWT
    "passlib[bcrypt]>=1.7.4",    # 密码哈希
    "httpx>=0.24.0",             # HTTP客户端
    "aiofiles>=23.0.0",          # 异步文件
]
```

### 5.3 项目结构设计

```
pdfmaster/
├── docs/                          # 文档目录
│   ├── 需求规格说明书.md
│   ├── API设计文档.md
│   ├── 部署指南.md
│   └── 开发规范.md
│
├── src/                           # 源代码目录
│   ├── api/                       # API层
│   │   ├── __init__.py
│   │   ├── main.py               # FastAPI入口
│   │   ├── routes/               # 路由模块
│   │   │   ├── __init__.py
│   │   │   ├── pdf.py            # PDF操作路由
│   │   │   ├── extract.py        # 提取路由
│   │   │   ├── convert.py        # 转换路由
│   │   │   ├── edit.py           # 编辑路由
│   │   │   ├── security.py       # 安全路由
│   │   │   ├── ocr.py            # OCR路由
│   │   │   ├── ai.py             # AI路由
│   │   │   └── task.py           # 任务路由
│   │   ├── dependencies.py       # 依赖注入
│   │   └── middleware.py         # 中间件
│   │
│   ├── services/                  # 服务层
│   │   ├── __init__.py
│   │   ├── core_service.py       # 基础操作服务
│   │   ├── extract_service.py    # 内容提取服务
│   │   ├── convert_service.py    # 格式转换服务
│   │   ├── edit_service.py       # 编辑处理服务
│   │   ├── security_service.py   # 安全处理服务
│   │   ├── ocr_service.py        # OCR识别服务
│   │   ├── ai_service.py         # AI智能服务
│   │   └── task_service.py       # 任务调度服务
│   │
│   ├── engines/                   # 引擎层
│   │   ├── __init__.py
│   │   ├── pdf/                  # PDF引擎
│   │   │   ├── __init__.py
│   │   │   ├── creator.py        # PDF创建
│   │   │   ├── merger.py         # PDF合并
│   │   │   ├── splitter.py       # PDF拆分
│   │   │   ├── compressor.py     # PDF压缩
│   │   │   └── page_manager.py   # 页面管理
│   │   ├── extract/              # 提取引擎
│   │   │   ├── __init__.py
│   │   │   ├── text_extractor.py
│   │   │   ├── image_extractor.py
│   │   │   ├── table_extractor.py
│   │   │   └── annotation_extractor.py
│   │   ├── convert/              # 转换引擎
│   │   │   ├── __init__.py
│   │   │   ├── pdf_to_word.py
│   │   │   ├── pdf_to_excel.py
│   │   │   ├── pdf_to_image.py
│   │   │   └── image_to_pdf.py
│   │   ├── security/             # 安全引擎
│   │   │   ├── __init__.py
│   │   │   ├── encryptor.py
│   │   │   ├── signer.py
│   │   │   └── redactor.py
│   │   └── ocr/                  # OCR引擎
│   │       ├── __init__.py
│   │       ├── tesseract_engine.py
│   │       ├── paddle_engine.py
│   │       └── layout_analyzer.py
│   │
│   ├── models/                    # 数据模型
│   │   ├── __init__.py
│   │   ├── base.py               # 基础模型
│   │   ├── user.py               # 用户模型
│   │   ├── file.py               # 文件模型
│   │   ├── task.py               # 任务模型
│   │   └── schemas/              # Pydantic模型
│   │       ├── __init__.py
│   │       ├── pdf.py
│   │       ├── extract.py
│   │       ├── convert.py
│   │       └── task.py
│   │
│   ├── core/                      # 核心模块
│   │   ├── __init__.py
│   │   ├── config.py             # 配置管理
│   │   ├── security.py           # 安全工具
│   │   ├── exceptions.py         # 异常定义
│   │   └── constants.py          # 常量定义
│   │
│   ├── db/                        # 数据库
│   │   ├── __init__.py
│   │   ├── session.py            # 数据库会话
│   │   ├── repositories/         # 数据仓库
│   │   └── migrations/           # 数据库迁移
│   │
│   ├── storage/                   # 存储模块
│   │   ├── __init__.py
│   │   ├── local.py              # 本地存储
│   │   ├── s3.py                 # S3存储
│   │   └── minio.py              # MinIO存储
│   │
│   ├── workers/                   # Celery任务
│   │   ├── __init__.py
│   │   ├── celery_app.py
│   │   ├── pdf_tasks.py
│   │   ├── ocr_tasks.py
│   │   └── ai_tasks.py
│   │
│   └── utils/                     # 工具模块
│       ├── __init__.py
│       ├── file_utils.py
│       ├── image_utils.py
│       └── text_utils.py
│
├── tests/                         # 测试目录
│   ├── __init__.py
│   ├── conftest.py
│   ├── test_api/
│   ├── test_services/
│   └── test_engines/
│
├── frontend/                      # 前端目录
│   ├── web/                       # Web应用
│   │   ├── src/
│   │   ├── package.json
│   │   └── vite.config.ts
│   └── desktop/                   # 桌面应用
│       ├── src/
│       └── package.json
│
├── docker/                        # Docker配置
│   ├── Dockerfile
│   ├── Dockerfile.worker
│   └── docker-compose.yml
│
├── scripts/                       # 脚本目录
│   ├── setup.sh
│   └── deploy.sh
│
├── requirements/                   # 依赖文件
│   ├── base.txt
│   ├── dev.txt
│   └── prod.txt
│
├── pyproject.toml                 # 项目配置
├── setup.py
├── README.md
└── LICENSE
```

---

## 6. API接口设计

### 6.1 API设计规范

#### 6.1.1 RESTful API规范

```
基础URL: https://api.pdfmaster.com/v1

资源命名规范：
- 使用名词复数形式：/files, /tasks
- 使用小写字母和连字符：/pdf-files
- 避免嵌套过深：最多3层

HTTP方法语义：
- GET：获取资源
- POST：创建资源
- PUT：完整更新资源
- PATCH：部分更新资源
- DELETE：删除资源

状态码规范：
- 200：成功
- 201：创建成功
- 204：删除成功（无返回内容）
- 400：请求参数错误
- 401：未认证
- 403：无权限
- 404：资源不存在
- 422：验证错误
- 429：请求过于频繁
- 500：服务器内部错误
```

#### 6.1.2 统一响应格式

```python
from pydantic import BaseModel
from typing import Generic, TypeVar, Optional, List
from datetime import datetime

T = TypeVar('T')

class APIResponse(BaseModel, Generic[T]):
    success: bool
    data: Optional[T] = None
    error: Optional[dict] = None
    meta: Optional[dict] = None

class PaginatedResponse(BaseModel, Generic[T]):
    success: bool
    data: List[T]
    meta: dict = {
        "total": 0,
        "page": 1,
        "page_size": 20,
        "total_pages": 0
    }

class ErrorDetail(BaseModel):
    code: str
    message: str
    details: Optional[dict] = None
```

#### 6.1.3 认证授权

```python
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
from jose import JWTError, jwt

security = HTTPBearer()

async def get_current_user(
    credentials: HTTPAuthorizationCredentials = Depends(security)
) -> User:
    try:
        payload = jwt.decode(
            credentials.credentials,
            settings.SECRET_KEY,
            algorithms=[settings.ALGORITHM]
        )
        user_id = payload.get("sub")
        if user_id is None:
            raise HTTPException(
                status_code=status.HTTP_401_UNAUTHORIZED,
                detail="无效的认证凭据"
            )
    except JWTError:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="无效的认证凭据"
        )
    
    user = await User.get(user_id)
    if user is None:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="用户不存在"
        )
    return user
```

### 6.2 完整API端点列表

#### 6.2.1 文件管理API

| 方法 | 端点 | 描述 |
|-----|------|------|
| POST | /api/v1/files/upload | 上传文件 |
| GET | /api/v1/files/{file_id} | 获取文件信息 |
| GET | /api/v1/files/{file_id}/download | 下载文件 |
| DELETE | /api/v1/files/{file_id} | 删除文件 |
| GET | /api/v1/files | 获取文件列表 |

#### 6.2.2 PDF基础操作API

| 方法 | 端点 | 描述 |
|-----|------|------|
| POST | /api/v1/pdf/create | 创建PDF |
| POST | /api/v1/pdf/merge | 合并PDF |
| POST | /api/v1/pdf/split | 拆分PDF |
| POST | /api/v1/pdf/compress | 压缩PDF |
| POST | /api/v1/pdf/pages/rotate | 旋转页面 |
| DELETE | /api/v1/pdf/pages | 删除页面 |
| POST | /api/v1/pdf/pages/extract | 提取页面 |
| POST | /api/v1/pdf/pages/crop | 裁剪页面 |

#### 6.2.3 内容提取API

| 方法 | 端点 | 描述 |
|-----|------|------|
| POST | /api/v1/extract/text | 提取文本 |
| POST | /api/v1/extract/images | 提取图片 |
| POST | /api/v1/extract/tables | 提取表格 |
| POST | /api/v1/extract/annotations | 提取注释 |
| POST | /api/v1/extract/metadata | 提取元数据 |

#### 6.2.4 格式转换API

| 方法 | 端点 | 描述 |
|-----|------|------|
| POST | /api/v1/convert/pdf-to-word | PDF转Word |
| POST | /api/v1/convert/pdf-to-excel | PDF转Excel |
| POST | /api/v1/convert/pdf-to-image | PDF转图片 |
| POST | /api/v1/convert/pdf-to-html | PDF转HTML |
| POST | /api/v1/convert/pdf-to-pdfa | PDF转PDF/A |
| POST | /api/v1/convert/word-to-pdf | Word转PDF |
| POST | /api/v1/convert/excel-to-pdf | Excel转PDF |
| POST | /api/v1/convert/html-to-pdf | HTML转PDF |
| POST | /api/v1/convert/image-to-pdf | 图片转PDF |

#### 6.2.5 编辑操作API

| 方法 | 端点 | 描述 |
|-----|------|------|
| POST | /api/v1/edit/text/add | 添加文本 |
| POST | /api/v1/edit/text/modify | 修改文本 |
| POST | /api/v1/edit/image/add | 添加图片 |
| DELETE | /api/v1/edit/image | 删除图片 |
| POST | /api/v1/edit/watermark/add | 添加水印 |
| DELETE | /api/v1/edit/watermark | 删除水印 |
| POST | /api/v1/edit/header-footer/add | 添加页眉页脚 |
| POST | /api/v1/edit/annotation/add | 添加注释 |
| DELETE | /api/v1/edit/annotation | 删除注释 |

#### 6.2.6 安全处理API

| 方法 | 端点 | 描述 |
|-----|------|------|
| POST | /api/v1/security/encrypt | 加密PDF |
| POST | /api/v1/security/decrypt | 解密PDF |
| POST | /api/v1/security/sign | 数字签名 |
| POST | /api/v1/security/verify-signature | 验证签名 |
| POST | /api/v1/security/redact | 敏感信息遮蔽 |
| POST | /api/v1/security/e-seal | 电子签章 |

#### 6.2.7 OCR识别API

| 方法 | 端点 | 描述 |
|-----|------|------|
| POST | /api/v1/ocr/recognize | 文字识别 |
| POST | /api/v1/ocr/layout-analysis | 版面分析 |

#### 6.2.8 AI智能API

| 方法 | 端点 | 描述 |
|-----|------|------|
| POST | /api/v1/ai/summarize | 智能摘要 |
| POST | /api/v1/ai/chat | 智能问答 |
| POST | /api/v1/ai/translate | 智能翻译 |
| POST | /api/v1/ai/generate-bookmarks | 智能书签 |

#### 6.2.9 任务管理API

| 方法 | 端点 | 描述 |
|-----|------|------|
| POST | /api/v1/tasks/create | 创建任务 |
| GET | /api/v1/tasks/{task_id} | 获取任务状态 |
| DELETE | /api/v1/tasks/{task_id} | 取消任务 |
| GET | /api/v1/tasks | 获取任务列表 |
| POST | /api/v1/batch/create | 创建批量任务 |

---

## 7. 数据存储设计

### 7.1 数据库设计

#### 7.1.1 用户表 (users)

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100),
    avatar_url VARCHAR(500),
    is_active BOOLEAN DEFAULT TRUE,
    is_verified BOOLEAN DEFAULT FALSE,
    role VARCHAR(20) DEFAULT 'user',  -- user, admin, enterprise
    storage_quota BIGINT DEFAULT 1073741824,  -- 1GB
    storage_used BIGINT DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_login_at TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
```

#### 7.1.2 文件表 (files)

```sql
CREATE TABLE files (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    original_name VARCHAR(255) NOT NULL,
    stored_name VARCHAR(255) NOT NULL,
    mime_type VARCHAR(100),
    file_size BIGINT NOT NULL,
    file_hash VARCHAR(64),  -- SHA256
    storage_path VARCHAR(500) NOT NULL,
    storage_type VARCHAR(20) DEFAULT 'local',  -- local, s3, minio
    
    -- PDF特有字段
    page_count INTEGER,
    pdf_version VARCHAR(10),
    is_encrypted BOOLEAN DEFAULT FALSE,
    is_searchable BOOLEAN DEFAULT TRUE,
    
    -- 元数据
    metadata JSONB DEFAULT '{}',
    
    -- 状态
    status VARCHAR(20) DEFAULT 'active',  -- active, deleted, processing
    expires_at TIMESTAMP WITH TIME ZONE,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    deleted_at TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_files_user_id ON files(user_id);
CREATE INDEX idx_files_status ON files(status);
CREATE INDEX idx_files_created_at ON files(created_at);
```

#### 7.1.3 任务表 (tasks)

```sql
CREATE TABLE tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    task_type VARCHAR(50) NOT NULL,  -- merge, split, convert, ocr, etc.
    status VARCHAR(20) DEFAULT 'pending',  -- pending, processing, completed, failed
    progress INTEGER DEFAULT 0,  -- 0-100
    
    -- 输入输出
    input_files JSONB DEFAULT '[]',  -- [{file_id, params}]
    output_files JSONB DEFAULT '[]',  -- [{file_id, name}]
    
    -- 参数和结果
    params JSONB DEFAULT '{}',
    result JSONB DEFAULT '{}',
    error_message TEXT,
    
    -- 优先级和回调
    priority INTEGER DEFAULT 5,  -- 1-10
    callback_url VARCHAR(500),
    
    -- 时间
    started_at TIMESTAMP WITH TIME ZONE,
    completed_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_tasks_user_id ON tasks(user_id);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_type ON tasks(task_type);
```

#### 7.1.4 API密钥表 (api_keys)

```sql
CREATE TABLE api_keys (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    key_hash VARCHAR(255) NOT NULL,
    key_prefix VARCHAR(8) NOT NULL,  -- 密钥前缀用于识别
    
    permissions JSONB DEFAULT '["read", "write"]',
    rate_limit INTEGER DEFAULT 1000,  -- 每小时请求数
    is_active BOOLEAN DEFAULT TRUE,
    
    last_used_at TIMESTAMP WITH TIME ZONE,
    expires_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_api_keys_user_id ON api_keys(user_id);
CREATE INDEX idx_api_keys_prefix ON api_keys(key_prefix);
```

#### 7.1.5 操作日志表 (audit_logs)

```sql
CREATE TABLE audit_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    action VARCHAR(50) NOT NULL,
    resource_type VARCHAR(50) NOT NULL,
    resource_id UUID,
    
    details JSONB DEFAULT '{}',
    ip_address INET,
    user_agent TEXT,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);
```

### 7.2 缓存设计

#### 7.2.1 Redis缓存策略

```python
REDIS_KEY_PREFIX = "pdfmaster:"

CACHE_CONFIG = {
    # 文件元数据缓存
    "file_metadata": {
        "key_pattern": f"{REDIS_KEY_PREFIX}file:{{file_id}}:meta",
        "ttl": 3600,  # 1小时
    },
    
    # 用户会话缓存
    "user_session": {
        "key_pattern": f"{REDIS_KEY_PREFIX}session:{{session_id}}",
        "ttl": 86400,  # 24小时
    },
    
    # 任务状态缓存
    "task_status": {
        "key_pattern": f"{REDIS_KEY_PREFIX}task:{{task_id}}:status",
        "ttl": 86400 * 7,  # 7天
    },
    
    # 速率限制
    "rate_limit": {
        "key_pattern": f"{REDIS_KEY_PREFIX}ratelimit:{{user_id}}:{{endpoint}}",
        "ttl": 3600,  # 1小时
    },
    
    # PDF处理结果缓存
    "pdf_result": {
        "key_pattern": f"{REDIS_KEY_PREFIX}pdf:{{file_hash}}:{{operation}}",
        "ttl": 86400 * 30,  # 30天
    },
}
```

### 7.3 文件存储设计

#### 7.3.1 存储架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        文件存储架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐       │
│  │  上传文件   │────►│  存储路由   │────►│  存储后端   │       │
│  └─────────────┘     └─────────────┘     └─────────────┘       │
│                                                 │               │
│                    ┌────────────────────────────┼───────────┐   │
│                    │                            │           │   │
│                    ▼                            ▼           ▼   │
│              ┌──────────┐              ┌──────────┐ ┌──────────┐│
│              │ 本地存储 │              │   MinIO  │ │   S3     ││
│              │ (开发)   │              │ (私有云) │ │ (公有云) ││
│              └──────────┘              └──────────┘ └──────────┘│
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 7.3.2 存储路径规范

```
存储根目录/
├── uploads/                      # 用户上传文件
│   ├── {year}/
│   │   ├── {month}/
│   │   │   ├── {day}/
│   │   │   │   ├── {user_id}/
│   │   │   │   │   ├── {file_id}.pdf
│   │   │   │   │   └── {file_id}.pdf.meta
│
├── processed/                    # 处理后文件
│   ├── {operation}/
│   │   ├── {year}/
│   │   │   ├── {file_id}_result.pdf
│
├── temp/                         # 临时文件
│   ├── {session_id}/
│   │   ├── temp_file.pdf
│
└── cache/                        # 缓存文件
    ├── thumbnails/
    │   ├── {file_id}_thumb.png
    └── previews/
        ├── {file_id}_preview.pdf
```

---

## 8. 安全设计

### 8.1 认证授权

#### 8.1.1 认证方式

| 认证方式 | 适用场景 | 实现方式 |
|---------|---------|---------|
| JWT Token | Web应用、API | RS256签名 |
| API Key | 开发者API | HMAC签名 |
| OAuth 2.0 | 第三方登录 | 标准OAuth流程 |
| Session | 传统Web |